# Usar Alpine para imagen ultra-ligera
FROM python:3.11-alpine

# Instalar dependencias de compilaci칩n
RUN apk add --no-cache --virtual .build-deps \
    gcc g++ make musl-dev libffi-dev openssl-dev \
    && apk add --no-cache libstdc++

WORKDIR /app

# Copiar requirements
COPY requirements-simple.txt requirements.txt

# Instalar dependencias (esto ser치 m치s peque침o con CPU-only torch)
RUN pip install --no-cache-dir torch==2.2.0 --index-url https://download.pytorch.org/whl/cpu \
    && pip install --no-cache-dir -r requirements.txt \
    && apk del .build-deps \
    && rm -rf /root/.cache/pip

# Copiar solo archivos necesarios
COPY app_simple.py app.py
COPY config.json generation_config.json ./
COPY source.spm target.spm tokenizer_config.json special_tokens_map.json vocab.json ./
COPY model.safetensors ./

EXPOSE 8000

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    TORCH_NUM_THREADS=2 \
    PORT=8000

CMD uvicorn app:app --host 0.0.0.0 --port $PORT --workers 1
